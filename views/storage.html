<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage</title>
    <link rel="stylesheet" href="/static/css/storage.css">
</head>
<body>
<script>
    async function handleLogout() {
        try {
            const response = await fetch('/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include' // Важно для работы с сессиями
            });

            if (response.ok) {
                window.location.href = '/'; // Перенаправление на страницу входа
            } else {
                console.error('Logout failed');
            }
        } catch (error) {
            console.error('Error during logout:', error);
        }
    }
</script>

<div class="header">
    <div class="logo">| web scape</div>
    <div class="user-info">
        <button onclick="window.location.href='/user.html'" class="profile-btn">Profile</button>
        <button onclick="handleLogout()" class="logout-btn">Logout</button>
        <img src="/static/img/avatar.png" alt="User Avatar">
        <span>{{.Username}}</span>
    </div>
</div>

<div class="content-wrapper">
    <div class="sidebar">
        <form id="uploadForm" enctype="multipart/form-data" method="post" action="/storage/upload">
            <input type="file" name="file" id="fileInput" hidden>
            <button type="button" onclick="document.getElementById('fileInput').click()">Upload File</button>
            <button type="submit">Submit Upload</button>
        </form>
        <button onclick="fetchFiles()">All Files</button>
    </div>

    <div class="main-content">
        <input type="text" placeholder="Search files..." class="search-box" id="searchBox" oninput="searchFiles()">

        <div id="fileList" class="file-list">
        </div>
    </div>
</div>

<div class="notification" id="notification" style="display: none;">File uploaded successfully!</div>

<script>
    async function viewFile(fileName) {
        try {
            const response = await fetch(`/storage/view?file=${encodeURIComponent(fileName)}`);
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Файл не найден');
                } else {
                    throw new Error('Ошибка при открытии файла');
                }
            }

            // Получаем blob из ответа
            const blob = await response.blob();

            // Создаем URL для blob
            const url = window.URL.createObjectURL(blob);

            // Открываем URL в новом окне
            window.open(url, '_blank');

            // Освобождаем URL после открытия
            setTimeout(() => window.URL.revokeObjectURL(url), 100);
        } catch (error) {
            alert(error.message);
        }
    }

    async function editFile(fileName) {
        try {
            const response = await fetch(`/storage/view?file=${encodeURIComponent(fileName)}`);
            if (!response.ok) throw new Error('Ошибка получения содержимого файла');

            const content = await response.text();
            const newContent = prompt('Редактировать содержимое файла:', content);

            if (newContent !== null) {
                const saveResponse = await fetch('/storage/edit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `file=${encodeURIComponent(fileName)}&content=${encodeURIComponent(newContent)}`
                });

                if (!saveResponse.ok) throw new Error('Ошибка сохранения файла');

                alert('Файл успешно сохранен');
                await fetchFiles(); // Обновляем список файлов
            }
        } catch (error) {
            alert('Ошибка при редактировании файла: ' + error.message);
        }
    }

    async function deleteFile(fileName) {
        if (confirm(`Вы уверены, что хотите удалить файл ${fileName}?`)) {
            try {
                const response = await fetch(`/storage/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `file=${encodeURIComponent(fileName)}`
                });

                if (!response.ok) throw new Error('Ошибка удаления файла');

                alert('Файл успешно удален');
                await fetchFiles(); // Обновляем список файлов
            } catch (error) {
                alert('Ошибка при удалении файла: ' + error.message);
            }
        }
    }

    // Обновленная функция fetchFiles с обработкой ошибок на русском
    async function fetchFiles() {
        try {
            const response = await fetch('/storage/files');
            if (!response.ok) throw new Error('Ошибка получения списка файлов');

            const files = await response.json();
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            if (Array.isArray(files) && files.length > 0) {
                files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.classList.add('file-item');
                    fileItem.innerHTML = `
                        <span class="file-name">${file}</span>
                        <div class="file-actions">
                            <button class="view-btn" onclick="viewFile('${file}')">Просмотр</button>
                            <button class="edit-btn" onclick="editFile('${file}')">Редактировать</button>
                            <button class="delete-btn" onclick="deleteFile('${file}')">Удалить</button>
                        </div>
                    `;
                    fileList.appendChild(fileItem);
                });
            } else {
                fileList.innerHTML = '<div class="no-files">Файлы не найдены</div>';
            }
        } catch (error) {
            console.error('Ошибка:', error);
            document.getElementById('fileList').innerHTML =
                '<div class="error">Ошибка загрузки файлов. Пожалуйста, попробуйте снова.</div>';
        }
    }

    // Вызываем fetchFiles при загрузке страницы
    document.addEventListener('DOMContentLoaded', fetchFiles);
</script>

</body>
</html>
