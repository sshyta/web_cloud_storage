<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage</title>
    <link rel="stylesheet" href="/static/css/storage.css">
</head>
<body>
<script>
    async function handleLogout() {
        try {
            const response = await fetch('/logout', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include' // Важно для работы с сессиями
            });

            if (response.ok) {
                window.location.href = '/'; // Перенаправление на страницу входа
            } else {
                console.error('Logout failed');
            }
        } catch (error) {
            console.error('Error during logout:', error);
        }
    }
</script>

<div class="header">
    <div class="logo">| web scape</div>
    <div class="user-info">
        <button onclick="window.location.href='/user.html'" class="profile-btn">Profile</button>
        <button onclick="handleLogout()" class="logout-btn">Logout</button>
        <img src="/static/img/avatar.png" alt="User Avatar">
        <span>{{.Username}}</span>
    </div>
</div>

<div class="content-wrapper">
    <div class="sidebar">
        <form id="uploadForm" enctype="multipart/form-data" method="post" action="/storage/upload">
            <input type="file" name="file" id="fileInput" hidden>
            <button type="button" onclick="document.getElementById('fileInput').click()">Upload File</button>
            <button type="submit">Submit Upload</button>
        </form>
        <button onclick="fetchFiles()">All Files</button>
    </div>

    <div class="main-content">
        <input type="text" placeholder="Search files..." class="search-box" id="searchBox" oninput="searchFiles()">

        <div id="fileList" class="file-list">
        </div>
    </div>
</div>

<div class="notification" id="notification" style="display: none;">File uploaded successfully!</div>

<script>
    async function viewFile(fileName) {
        try {
            const response = await fetch(`/storage/view?file=${encodeURIComponent(fileName)}`);
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Файл не найден');
                } else {
                    throw new Error('Ошибка при открытии файла');
                }
            }

            // Получаем blob из ответа
            const blob = await response.blob();

            // Создаем URL для blob
            const url = window.URL.createObjectURL(blob);

            // Открываем URL в новом окне
            window.open(url, '_blank');

            // Освобождаем URL после открытия
            setTimeout(() => window.URL.revokeObjectURL(url), 100);
        } catch (error) {
            alert(error.message);
        }
    }

    async function editFile(fileName) {
        try {
            // Получаем содержимое файла
            const response = await fetch(`/storage/view?file=${encodeURIComponent(fileName)}`);
            if (!response.ok) {
                throw new Error('Ошибка получения содержимого файла');
            }
            const content = await response.text();

            // Создаем модальное окно для редактирования
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';

            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '5px';
            modalContent.style.width = '80%';
            modalContent.style.maxWidth = '600px';

            const textarea = document.createElement('textarea');
            textarea.value = content;
            textarea.style.width = '100%';
            textarea.style.height = '300px';
            textarea.style.marginBottom = '10px';

            const saveButton = document.createElement('button');
            saveButton.textContent = 'Сохранить';
            saveButton.onclick = async () => {
                try {
                    const saveResponse = await fetch('/storage/edit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `file=${encodeURIComponent(fileName)}&content=${encodeURIComponent(textarea.value)}`
                    });

                    if (!saveResponse.ok) {
                        throw new Error('Ошибка сохранения файла');
                    }

                    alert('Файл успешно сохранен');
                    document.body.removeChild(modal);
                    await fetchFiles(); // Обновляем список файлов
                } catch (error) {
                    alert('Ошибка при сохранении файла: ' + error.message);
                }
            };

            const cancelButton = document.createElement('button');
            cancelButton.textContent = 'Отмена';
            cancelButton.onclick = () => {
                document.body.removeChild(modal);
            };

            modalContent.appendChild(textarea);
            modalContent.appendChild(saveButton);
            modalContent.appendChild(cancelButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        } catch (error) {
            alert('Ошибка при редактировании файла: ' + error.message);
        }
    }

    async function deleteFile(fileName) {
        if (confirm(`Вы уверены, что хотите удалить файл ${fileName}?`)) {
            try {
                const response = await fetch(`/storage/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `file=${encodeURIComponent(fileName)}`
                });

                if (!response.ok) throw new Error('Ошибка удаления файла');

                alert('Файл успешно удален');
                await fetchFiles(); // Обновляем список файлов
            } catch (error) {
                alert('Ошибка при удалении файла: ' + error.message);
            }
        }
    }

    async function downloadFile(fileName) {
        try {
            const response = await fetch(`/storage/download?file=${encodeURIComponent(fileName)}`);
            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('Файл не найден');
                } else {
                    throw new Error('Ошибка при скачивании файла');
                }
            }

            // Получаем blob из ответа
            const blob = await response.blob();

            // Создаем ссылку для скачивания
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();

            // Удаляем ссылку после скачивания
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        } catch (error) {
            alert(error.message);
        }
    }

    // Обновляем функцию fetchFiles, чтобы использовать новую кнопку
    async function fetchFiles() {
        try {
            const response = await fetch('/storage/files');
            if (!response.ok) throw new Error('Ошибка получения списка файлов');

            const files = await response.json();
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            if (Array.isArray(files) && files.length > 0) {
                files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.classList.add('file-item');
                    fileItem.innerHTML = `
                        <span class="file-name">${file}</span>
                        <div class="file-actions">
                            <button class="download-btn" onclick="downloadFile('${file}')">Скачать</button>
                            <button class="edit-btn" onclick="editFile('${file}')">Редактировать</button>
                            <button class="delete-btn" onclick="deleteFile('${file}')">Удалить</button>
                        </div>
                    `;
                    fileList.appendChild(fileItem);
                });
            } else {
                fileList.innerHTML = '<div class="no-files">Файлы не найдены</div>';
            }
        } catch (error) {
            console.error('Ошибка:', error);
            document.getElementById('fileList').innerHTML =
                '<div class="error">Ошибка загрузки файлов. Пожалуйста, попробуйте снова.</div>';
        }
    }

    // Вызываем fetchFiles при загрузке страницы
    document.addEventListener('DOMContentLoaded', fetchFiles);
</script>

</body>
</html>
